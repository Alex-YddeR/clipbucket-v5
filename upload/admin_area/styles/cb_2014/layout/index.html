<div class="heading">
    <h2>ClipBucket V{$VERSION} {$STATE} Dashboard</h2>
</div>
<div class="row">
	<div class="col-md-6">
		<div id="piechart" style="height:430px;" ></div>
	</div>
	<div class="col-md-6">
		<div id="donutchart" style="height:430px;" ></div>
	</div>
</div>
<hr>
<div class="row">
	<div class="col-md-6">
		 <div id="ubarchart" style="height:400px;" ></div>
	</div>

	<div class="col-md-6">
		<div id="vbarchart" style="height:400px;" ></div>
	</div>
</div>
<hr>
<div class="row">
	<div class="col-md-6">
		<ul class="nav nav-tabs" id="myTab">
			<li class="active">
				<a data-toggle="tab" href="#todolist">
					<h5><i class="glyphicon glyphicon-list-alt"></i> ToDo List</h5>
				</a>
			</li>
			<li>
				<a data-toggle="tab" href="#pnotes">
					<h5><i class="glyphicon glyphicon-pencil"></i> Personal Notes</h5>
				</a>
			</li>
			<li>
				<a data-toggle="tab" href="#rcomments">
					<h5><i class="glyphicon glyphicon-comment"></i> Recent Comments</h5>
				</a>
			</li>
		</ul>
		<div class="tab-content">
			<div id="todolist" class="tab-pane active">
				<div class="widgetBox">
					<div class="addTodo paddingRightSmall paddingLeftLarge marginBottomLarge">
						<div class="row">
							<div class="from-group relative">
								<div class="from-group">
									<input type="text" name="addTodo" class="form-control addTodoText"/>
									<button id="addTodo" class="btn btn-primary btn-sm">{lang code='add'}</button>
								</div>
							</div>
						</div>
					</div>
					{assign var=todos value=$myquery->get_todos()}
					<ul class="row todosList" id="note-{$the_note.note_id}" >
						{foreach from=$todos item=note}
						<li class="col-md-12">
							<div class="col-md-12">
								<p class="oneTodo paddingLeftSmall col-md-10" id="{$note.todo_id}">
									{display_clean($note.todo)}
								</p>
								<a href="#" class="btn btn-danger btn-xs delete col-md-2">{lang code='delete'}</a>
							</div>
						</li>
						{/foreach}
					</ul>
				</div>
			</div>
			<div id="pnotes" class="tab-pane">
				<div class="widgetBox">
					<div class="addNote form-group paddingRightSmall">
						<textarea class="form-control" name="ntoe" id="note"></textarea>
						<div class="alignRight marginTopSmall">
							<a href="#" id="add_new_note" class="btn btn-primary btn-xs">Add a note</a>
						</div>
					</div>
					{assign var=notes value=$myquery->get_notes()}
					<ul class="notesList row paddingRightSmall" id="note-{$the_note.note_id}" >
						{foreach from=$notes item=note}
						<li class="col-md-4">
							<div>
								<p class="oneNote" id="{$note.note_id}">
									{display_clean($note.note)}
									<a href="#" class="delete">Ã—</a>
								</p>
							</div>
						</li>
						{/foreach}
					</ul>
				</div>
			</div>
			<div id="rcomments" class="tab-pane">
				{if $comments}
				<div class="widget-box">
					<div class="widget-header header-color-blue">
						<h5>Recent Comments</h5>
						<div class="widget-toolbar">
							<a href="#" data-action="collapse">
								<i class="icon-chevron-down"></i>
							</a>
							<a href="#" data-action="close">
								<i class="icon-remove"></i>
							</a>
						</div>
					</div>
					<div class="widget-body">
						<div class="widget-main">
							<div class="widget-box transparent">
								<div class="widget-header widget-header-small"></div>
								<div class="widget-body">
									<div class="widget-body">
										<div class="widget-main no-padding">
											<div class="slimScrollDiv">
												{foreach from=$comments item=comment}
												{$userdetails = $userquery->get_user_details($comment.userid)}
												<div class="itemdiv dialogdiv">
													<div class="user">
														<img alt="{display_clean($userdetails.username)}" title="{display_clean($userdetails.username)}" src="{$userquery->getUserThumb($userdetails,'small')}">
													</div>
													<div class="body">
														<div class="time">
															<i class="icon-time"></i>
															<span class="green">{$comment.date_added|date_format}</span>
														</div>
														<div class="name">
															<a href="#">{display_clean($comment.anonym_name)}</a>
														</div>
														<div class="text">{$comment.comment|comment}</div>
														<div class="tools">
															<a href="{getCommentAdminLink($comment.type, $comment.type_id)}" class="btn btn-minier btn-info">
																<i class="icon-only icon-share-alt"></i>
															</a>
														</div>
													</div>
												</div>
												{/foreach}

											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				{/if}
			</div>
		</div>
	</div>
</div>
<hr>
<div class="row">
	<div class="col-md-12">
		<div class="well changelog">
			<h3>5.3.1 Changelog</h3>

			<b>Admin area</b>
			<ul>
				<li>Update changelog display</li>
				<li>Update lib amCharts to 3.21.15</li>
				<li>Remove Clipbucket news </li>
			</ul>
			<b>Video conversion</b>
			<ul>
				<li>Fix rare conversion fail</li>
			</ul>
			<b>Miscellaneous</b>
			<ul>
				<li>Remove unused files</li>
				<li>Cleanup code</li>
				<li>Fix installation <i>#120</i></li>
			</ul>
		</div>

		<div class="well changelog">
			<h3>5.0.0 - 5.3.0 Changelog <b class="arrow icon-angle-down"></b></h3>
			<ul style="display:none;">
				<li><b>PHP 7.3 compatibility</b></li>
				<li><b>Refactor data storage</b></li>
				<i>Data are not transformed before storage anymore (<b>"</b>Greeting: "Hello, World!"<b>"</b> was stored as <b>"</b>Greeting: &amp;quot;Hello, World!&amp;quot;<b>"</b>)</i>
				<li><b>Implement MySQL reconnect</b></li>
				<i>When PHP lost the MySQL connection, it is now able to reconnect without generating a fatal error</i>
				<li><b>Refactor back office mass upload</b></li>
				<i>It now supports reccurcive directory, huge files import, language selection, display usefull informations, is faster, safer</i>
				<li><b>Refactor back office breadcrumb</b></li>
				<i>Items are now clickable, more precise and subpages are now supported</i>
				<li><b>Refactor the front office video "add to" tab</b></li>
				<i>New way to display elements : more mobile friendly, fix bugs, ...</i>
				<li><b>Refactor error handling</b></li>
				<i>Update the way error messages are managed</i>
				<li><b>Upgrade video convertion</b></li>
				<i>Better tasklist support (no more full cpu charge when waiting for lock), support for audio track selection, fix audio negative start time, better 16:9 resolution and codecs detection</i>
				<li><b>Implement Chromecast Support with back office option</b></li>
				<i>This option enable the Chromecast support on the default video player</i>
				<li><b>Upgrade users passwords security</b></li>
				<i>Replace the MD5 implementation with salted SHA512</i>
				<li><b>Implement search for collections</b></li>
				<i>Search for collection like you do it for videos</i>
				<li><b>Implement new option to totally disable ads</b></li>
				<i>This option disable back office menu, JS and CSS front office integration, specific HTML elements for ads</i>
				<li><b>Implement new option to differentiate video and photo allowed extensions</b></li>
				<i>There's now two distincts lists of allowed extensions</i>
				<li><b>Implement new users permissions</b></li>
				<i>New permissions to limit the access to photos, collections, apply existing permissions on missing spots (like search)</i>
				<li><b>Easy installation scripts</b></li>
				<i>Don't search anymore for Debian 9 & 10, Ubuntu 17.10 & 16.04, CentOS 7 installation, there's a script for that now</i>
				<li><b>Update VideoJS Player</b></li>
				<i>VideoJS Player has been updated to 7.8.1</i>
				<li><b>Fixs</b></li>
				<i>Fix HTML/CSS/JS error/warnings/notices, many broken configurations, installation process, infinite loops, email tester, back office and front office pagination, many thumbs display, ...</i>
				<li><b>Others</b></li>
				<i>Fix typos, cleanup installation SQL, cleanup code, use translation instead of hardcoded texts, remove unused code and files (including a full back office unused theme), document PHP functions, use relative URLs, don't allow to play a video while it is converting, ...</i>
			</ul>
		</div>
	</div>
</div>

<script type="text/javascript">
	AmCharts.makeChart("piechart", {
		"type": "pie",
		"adjustPrecision": true,
		"angle": 12,
		"balloonText": "[[title]]<br><span style='font-size:14px'><b>[[value]]</b> ([[percents]]%)</span>",
		"depth3D": 15,
		"maxLabelWidth": 150,
		"titleField": "category",
		"valueField": "column-1",
		"processTimeout": 5,
		"theme": "light",
		"allLabels": [],
		"balloon": {},
		"legend": {
			"enabled": true,
			"align": "left",
			"markerType": "circle"
		},
		"titles": [
			{
				"bold": false,
				"id": "Title-1",
				"size": 15,
				"text": "Overall Statistics"
			}
		],
		"dataProvider": [
			{
				"category": "Users",
				"column-1": '{get_users count_only=yes}'
			},
			{
				"category": "Photos",
				"column-1": '{get_photos count_only=yes}'
			},
			{
				"category": "Videos",
				"column-1": '{get_videos count_only=yes}'
			},
			{
				"category": "Collections",
				"column-1": '{get_collections count_only=yes}'
			},

		]
	});

	AmCharts.makeChart("donutchart", {
		"type": "pie",
		"angle": 12,
		"balloonText": "[[title]]<br><span style='font-size:14px'><b>[[value]]</b> ([[percents]]%)</span>",
		"depth3D": 15,
		"innerRadius": "30%",
		"titleField": "category",
		"valueField": "column-1",
		"processTimeout": 5,
		"theme": "light",
		"allLabels": [],
		"balloon": {},
		"legend": {
			"enabled": true,
			"align": "center",
			"markerType": "circle"
		},
		"titles": [
			{
				"bold": false,
				"id": "Title-1",
				"size": 15,
				"text": "Flagged Objects"
			}
		],
		"dataProvider": [

			{
				"category": "Photos",
				"column-1": '{$cbphoto->action->count_flagged_objects()}'
			},
			{
				"category": "Videos",
				"column-1": '{$cbvid->action->count_flagged_objects()}'
			}
		]
	});

	AmCharts.makeChart("ubarchart", {
		"type": "serial",
		"pathToImages": "https://www.amcharts.com/lib/3/images/",
		"categoryField": "category",
		"startDuration": 1,
		"mouseWheelZoomEnabled": true,
		"startEffect": "easeOutSine",
		"autoDisplay": true,
		"theme": "light",
		"categoryAxis": {
			"gridPosition": "start"
		},
		"trendLines": [],
		"graphs": [
			{
				"colorField": "color",
				"fillAlphas": 1,
				"id": "AmGraph-1",
				"lineColorField": "color",
				"title": "graph 1",
				"type": "column",
				"valueField": "column-1"
			}
		],
		"guides": [],
		"valueAxes": [
			{
				"id": "ValueAxis-1",
				"title": "Users"
			}
		],
		"allLabels": [],
		"balloon": {},
		"titles": [
			{
				"bold": false,
				"id": "Title-1",
				"size": 15,
				"text": "Users Statistics"
			}
		],
		"dataProvider": [
			{
				"category": "Total",
				"column-1": '{get_users count_only=yes}'
			},
			{
				"category": "Active",
				"column-1": '{get_users count_only=yes status='Ok'}'
			},
			{
				"category": "Inactive",
				"column-1": '{get_users count_only=yes status='ToActivate'}'
			}
		]
	});

	AmCharts.makeChart("vbarchart", {
		"type": "serial",
		"pathToImages": "https://www.amcharts.com/lib/3/images/",
		"categoryField": "category",
		"startDuration": 1,
		"mouseWheelZoomEnabled": true,
		"startEffect": "easeOutSine",
		"autoDisplay": true,
		"theme": "light",
		"categoryAxis": {
			"gridPosition": "start"
		},
		"trendLines": [],
		"graphs": [
			{
				"colorField": "color",
				"fillAlphas": 1,
				"id": "AmGraph-1",
				"lineColorField": "color",
				"title": "graph 1",
				"type": "column",
				"valueField": "column-1"
			}
		],
		"guides": [],
		"valueAxes": [
			{
				"id": "ValueAxis-1",
				"title": "Videos"
			}
		],
		"allLabels": [],
		"balloon": {},
		"titles": [
			{
				"bold": false,
				"id": "Title-1",
				"size": 15,
				"text": "Video Statistics"
			}
		],
		"dataProvider": [
			{
				"category": "Total",
				"column-1": '{get_videos count_only=yes}'
			},
			{
				"category": "Active",
				"column-1": '{get_videos count_only=yes active="yes"}'
			},
			{
				"category": "Deactive",
				"column-1": '{get_videos count_only=yes active='no'}'
			},
			{
				"category": "Reported",
				"column-1": '{$cbvid->action->count_flagged_objects()}'
			}
		]
	});

 	$(function() {
		var page = '/admin_area/index.php';

        $(".oneNote .delete").on({
            click: function(e){
                e.preventDefault();
                var noteId = $(this).parent().attr("id");
                delete_note(noteId);
                $(this).parents("li").remove();
            }
        });

        $("#add_new_note").on({
            click: function(e){
                e.preventDefault();
                var self = this;
                var note = $(this).parents(".widgetBox").find("textarea").val();
                if(!note){
                    alert("Please enter something");
                }
                else{
                    $(this).parents(".widgetBox").find("textarea").val("");
                    $.post(page, {
                        mode : 'add_note',
                        note : note,
                    },function(data) {
                        var li = document.createElement("li");
                        li.className = "col-md-4";
                        var a = document.createElement("a");
                        a.className = "delete";
                        a.href = "#";
                        a.innerHTML = "x";
                        var p = document.createElement("p");
                        p.id = data.id;
                        p.innerHTML = note;
                        p.className = "oneNote";
                        $(p).append(a);
                        $(li).append(p);
                        $(a).on({
                            click: function(e){
                                e.preventDefault();
                                var noteId = $(this).parent().attr("id");
                                delete_note(noteId);
                                $(this).parents("li").remove();
                            }
                        });
                        $(self).parents(".widgetBox").find("ul").prepend(li);
                    },'json');
                }
            }
        });

        $("#addTodo").on({
            click: function(e){
                e.preventDefault();
                var self = this;
                var newVal = $(this).parents(".addTodo").find("input").val();
                if(newVal.length)
                {
                    $(this).parents(".addTodo").find("input").val("");
                    var ajaxCall = $.ajax({
                        url: page,
                        type: "post",
                        data: {
                            val: newVal,
                            mode: "add_todo",
                        },
                    });
                    ajaxCall.success(function(data){
                        data = $.parseJSON(data);
                        var li = document.createElement("li");
                        li.className = "col-md-12";
                        var p = document.createElement("p");
                        p.className = "oneTodo paddingLeftSmall col-md-10";
                        p.id = data.id;
                        p.innerHTML = data.todo;
                        var a = document.createElement("a");
                        a.href = "#";
                        a.className = "col-md-2 btn btn-danger btn-xs delete";
                        a.innerHTML = "{lang code='delete'}";
                        $(a).on("click", function(e){
                            e.preventDefault();
                            var self = this;
                            var id = $(this).prev().attr("id");
                            var ajaxCall = $.ajax({
                                url: page,
                                type: "post",
                                data: {
                                    id: id,
                                    mode: "delete_todo",
                                },
                            });
                            ajaxCall.success(function(data){
                                $(self).parents("li").remove();
                            });

                        });
                        var div = document.createElement("div");
                        div.className = "col-md-12";

                        $(li).append(div).find("div").append(p).append(a);
                        $(self).parents(".widgetBox").find("ul").prepend(li);
                    });
                }else{
                    alert("Please enter a valid value");
                }
            }
        });

        $("#todolist .delete").on("click", function(e){
            e.preventDefault();
            var self = this;
            var id = $(this).prev().attr("id");
            var ajaxCall = $.ajax({
                url: page,
                type: "post",
                data: {
                    id: id,
                    mode: "delete_todo",
                },
            });
            ajaxCall.success(function(data){
                $(self).parents("li").remove();
            });

        });
    });
</script>